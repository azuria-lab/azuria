#!/usr/bin/env node
// Generates .env.cloud and .env.localdev from existing .env
import fs from 'node:fs';
import path from 'node:path';

const root = process.cwd();
const envPath = path.join(root, '.env');

if (!fs.existsSync(envPath)) {
  console.error('[env:generate] File .env not found at repo root.');
  process.exit(1);
}

/**
 * Minimal .env parser (no variable expansion). Supports KEY=VALUE and quoted values.
 */
function parseEnv(content) {
  const out = {};
  const lines = content.replaceAll('\r\n', '\n').split('\n');
  for (const raw of lines) {
      const line = raw.trim();
      if (!line || line.startsWith('#')) continue;
      const eq = line.indexOf('=');
      if (eq === -1) continue;
      const key = line.slice(0, eq).trim();
      let val = line.slice(eq + 1).trim();
      if ((val.startsWith('"') && val.endsWith('"')) || (val.startsWith('\'') && val.endsWith('\''))) {
        val = val.slice(1, -1);
      }
      out[key] = val;
    }
  return out;
}

function toEnvLines(obj) {
  return Object.entries(obj)
    .filter(([, v]) => v !== undefined && v !== null && `${v}`.length > 0)
    .map(([k, v]) => `${k}=${v}`)
    .join('\n') + '\n';
}

const src = parseEnv(fs.readFileSync(envPath, 'utf-8'));

// Cloud preset
const cloud = {
  VITE_SUPABASE_MODE: 'cloud',
  VITE_SUPABASE_URL: src.VITE_SUPABASE_URL || src.VITE_SUPABASE_CLOUD_URL || '',
  VITE_SUPABASE_ANON_KEY: src.VITE_SUPABASE_ANON_KEY || src.VITE_SUPABASE_CLOUD_ANON_KEY || '',
};
// Optional pass-through (if present)
if (src.VITE_SUPABASE_AUTH_URL) cloud.VITE_SUPABASE_AUTH_URL = src.VITE_SUPABASE_AUTH_URL;
if (src.VITE_SUPABASE_DATA_URL) cloud.VITE_SUPABASE_DATA_URL = src.VITE_SUPABASE_DATA_URL;

// Local preset
const local = {
  VITE_SUPABASE_MODE: 'local',
  VITE_SUPABASE_LOCAL_URL: src.VITE_SUPABASE_LOCAL_URL || 'http://localhost:54321',
  // Do NOT inherit cloud anon key; require explicit local anon key to avoid confusion
  VITE_SUPABASE_LOCAL_ANON_KEY: src.VITE_SUPABASE_LOCAL_ANON_KEY || '',
};
if (src.VITE_SUPABASE_LOCAL_AUTH_URL) local.VITE_SUPABASE_LOCAL_AUTH_URL = src.VITE_SUPABASE_LOCAL_AUTH_URL;
if (src.VITE_SUPABASE_LOCAL_DATA_URL) local.VITE_SUPABASE_LOCAL_DATA_URL = src.VITE_SUPABASE_LOCAL_DATA_URL;

// Hybrid preset (cloud auth + local data)
const hybrid = {
  VITE_SUPABASE_MODE: 'hybrid',
  VITE_SUPABASE_CLOUD_URL: src.VITE_SUPABASE_CLOUD_URL || src.VITE_SUPABASE_URL || '',
  VITE_SUPABASE_CLOUD_ANON_KEY: src.VITE_SUPABASE_CLOUD_ANON_KEY || src.VITE_SUPABASE_ANON_KEY || '',
  VITE_SUPABASE_LOCAL_URL: src.VITE_SUPABASE_LOCAL_URL || 'http://localhost:54321',
  VITE_SUPABASE_LOCAL_ANON_KEY: src.VITE_SUPABASE_LOCAL_ANON_KEY || '',
};
if (src.VITE_SUPABASE_AUTH_URL) hybrid.VITE_SUPABASE_AUTH_URL = src.VITE_SUPABASE_AUTH_URL;
if (src.VITE_SUPABASE_DATA_URL) hybrid.VITE_SUPABASE_DATA_URL = src.VITE_SUPABASE_DATA_URL;

const cloudOut = `# Generated by scripts/generate-env-presets.mjs\n# Cloud (Supabase Cloud)\n${toEnvLines(cloud)}`;
const localOut = `# Generated by scripts/generate-env-presets.mjs\n# Local (Supabase CLI/Docker)\n${toEnvLines(local)}`;
const hybridOut = `# Generated by scripts/generate-env-presets.mjs\n# Hybrid (Cloud Auth + Local Data)\n${toEnvLines(hybrid)}`;

fs.writeFileSync(path.join(root, '.env.cloud'), cloudOut, 'utf-8');
fs.writeFileSync(path.join(root, '.env.localdev'), localOut, 'utf-8');
fs.writeFileSync(path.join(root, '.env.hybrid'), hybridOut, 'utf-8');

console.log('[env:generate] Wrote .env.cloud, .env.localdev, and .env.hybrid from .env');
