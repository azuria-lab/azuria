# Azuria Production Setup Guide

This guide provides step-by-step instructions for deploying Azuria to production using Azure Static Web Apps.

## Prerequisites

1. **Azure Account**: Active Azure subscription
2. **GitHub Account**: Repository access and admin permissions
3. **Azure CLI**: Installed and authenticated (`az login`)
4. **Azure Developer CLI**: Installed (`azd version`)
5. **Node.js 18+**: For local development and testing

## Environment Variables

Create the following secrets in your GitHub repository settings:

### Azure Authentication
```bash
AZURE_CLIENT_ID=your-service-principal-client-id
AZURE_TENANT_ID=your-azure-tenant-id
AZURE_SUBSCRIPTION_ID=your-azure-subscription-id
AZURE_CLIENT_SECRET=your-service-principal-secret

# Azure Deployment
AZURE_ENV_NAME=azuria-prod
AZURE_LOCATION="East US 2"
```

### Application Configuration
```bash
# Supabase Production
NEXT_PUBLIC_SUPABASE_URL=https://crpzkppsriranmeumfqs.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-production-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-production-service-role-key

# Static Web Apps Deployment Token (generated by Azure)
AZURE_STATIC_WEB_APPS_API_TOKEN=your-deployment-token

# Application Insights (set after infrastructure deployment)
NEXT_PUBLIC_APPLICATION_INSIGHTS_CONNECTION_STRING=your-connection-string
```

## Deployment Steps

### 1. Create Azure Service Principal

```bash
# Create service principal for GitHub Actions
az ad sp create-for-rbac --name "azuria-github-actions" \
  --role contributor \
  --scopes /subscriptions/YOUR_SUBSCRIPTION_ID \
  --sdk-auth
```

Add the output to GitHub Secrets as individual values.

### 2. Deploy Infrastructure

```bash
# Clone and navigate to repository
git clone https://github.com/your-org/azuria.git
cd azuria

# Initialize Azure Developer CLI
azd auth login
azd env new azuria-prod

# Set environment variables
azd env set AZURE_LOCATION "East US 2"

# Deploy infrastructure
azd provision --preview  # Review changes
azd provision           # Deploy
```

### 3. Configure Static Web App

After infrastructure deployment:

1. **Get deployment token** from Azure portal:
   - Go to Static Web Apps → your-app → Manage deployment token
   - Copy the token to `AZURE_STATIC_WEB_APPS_API_TOKEN` GitHub secret

2. **Configure custom domain** (optional):
   - Azure portal → Static Web Apps → Custom domains
   - Add your domain and configure DNS

3. **Set environment variables** in Azure portal:
   ```
   NODE_ENV=production
   NEXT_PUBLIC_SUPABASE_URL=https://crpzkppsriranmeumfqs.supabase.co
   NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
   NEXT_PUBLIC_APPLICATION_INSIGHTS_CONNECTION_STRING=your-connection-string
   ```

### 4. Database Setup

```bash
# Apply database migration
cd supabase
supabase db push --project-ref crpzkppsriranmeumfqs

# Or apply manually via SQL editor
psql -h your-supabase-host -U postgres -d postgres -f migrations/20250927000001_create_marketplace_schema.sql
```

### 5. Configure Monitoring

1. **Application Insights Dashboard**:
   - Azure portal → Application Insights → your-instance
   - Create custom dashboards for business metrics

2. **Set up Alerts**:
   ```bash
   # Example: Alert on high error rate
   az monitor metrics alert create \
     --name "High Error Rate" \
     --resource-group "rg-azuria-prod" \
     --scopes "/subscriptions/YOUR_SUBSCRIPTION_ID/resourceGroups/rg-azuria-prod/providers/Microsoft.Insights/components/ai-your-token" \
     --condition "avg exceptions/count > 10" \
     --window-size 5m
   ```

## Security Checklist

- [ ] **HTTPS Enforcement**: Verify SSL certificates are active
- [ ] **CORS Configuration**: Review allowed origins in Static Web Apps
- [ ] **Authentication**: Test Supabase integration and RLS policies
- [ ] **Secrets Management**: Ensure sensitive data is in Key Vault
- [ ] **CSP Headers**: Verify Content Security Policy configuration
- [ ] **Rate Limiting**: Configure rate limits for API endpoints
- [ ] **Access Policies**: Review Azure RBAC and Static Web Apps roles

## Performance Optimization

1. **CDN Configuration**: Verify global distribution
2. **Caching**: Configure appropriate cache headers
3. **Bundle Analysis**: Monitor bundle size and performance
4. **Database Performance**: Review query performance and indexes

## Monitoring and Alerts

### Key Metrics to Monitor
- Application availability (uptime)
- Response time (95th percentile)
- Error rate (4xx/5xx responses)
- Database performance (query time)
- User engagement (page views, sessions)

### Recommended Alerts
- Error rate > 5% in 5-minute window
- Response time > 3 seconds (95th percentile)
- Database connection failures
- Failed authentication attempts

## Backup and Recovery

1. **Database Backups**: Supabase automated backups
2. **Static Assets**: Azure Storage replication
3. **Configuration**: Keep infrastructure as code in version control
4. **Disaster Recovery**: Document recovery procedures

## Support and Troubleshooting

### Common Issues

1. **Build Failures**: Check GitHub Actions logs
2. **Authentication Issues**: Verify Supabase configuration
3. **Performance Issues**: Check Application Insights metrics
4. **Database Issues**: Review Supabase dashboard and logs

### Debug Commands

```bash
# Check deployment status
azd show

# View application logs
azd logs

# Test database connection
psql -h your-supabase-host -U postgres -c "SELECT 1"

# Verify SSL certificate
curl -I https://your-app.azurestaticapps.net
```

## Maintenance

- **Regular Updates**: Keep dependencies up to date
- **Security Patches**: Monitor and apply security updates
- **Performance Reviews**: Monthly performance analysis
- **Cost Optimization**: Review Azure costs and optimize resources
- **Backup Testing**: Regularly test disaster recovery procedures

## Next Steps

After successful deployment:

1. **Load Testing**: Test application under expected load
2. **User Acceptance Testing**: Validate all features work correctly
3. **Documentation**: Update user guides and API documentation
4. **Training**: Train support team on monitoring and troubleshooting
5. **Go-Live**: Plan production launch and communication